import pytest
from mock import patch

from calc_moving_average import CalcMovingAverage

class TestBinanceResponse:
    def __init__(self):
        pass

    def get_klines(self, symbol='', interval=''):
        candles = [ [1625533500000, '34014.21000000', '34039.34000000', '34000.00000000', '34022.20000000', '32.43628200', 1625533559999, '1103320.21093401', 644, '10.99620900', '374113.41079568', '0'],
                    [1625533560000, '34022.20000000', '34033.83000000', '34017.08000000', '34018.05000000', '15.35809500', 1625533619999, '522584.66936203', 484, '7.10259700', '241684.96383034', '0'],
                    [1625533620000, '34016.95000000', '34032.35000000', '34014.02000000', '34032.30000000', '13.47556500', 1625533679999, '458542.46175613', 470, '10.99129900', '374010.55745170', '0'],
                    [1625533680000, '34032.30000000', '34043.85000000', '34000.00000000', '34000.00000000', '35.26929200', 1625533739999, '1199967.13103561', 547, '14.86035600', '505727.85660937', '0'],
                    [1625533740000, '34000.01000000', '34008.63000000', '33969.03000000', '33973.13000000', '25.35878000', 1625533799999, '861871.79103902', 729, '12.90778300', '438654.54994368', '0'],
                    [1625533800000, '33973.14000000', '33999.60000000', '33971.46000000', '33986.47000000', '14.66132700', 1625533859999, '498265.88154028', 555, '9.34350400', '317549.16316900', '0'],
                    [1625533860000, '33984.78000000', '33988.79000000', '33931.62000000', '33946.79000000', '36.98125300', 1625533919999, '1255562.55337878', 747, '21.22975200', '720662.43995249', '0'],
                    [1625533920000, '33946.79000000', '33969.86000000', '33946.79000000', '33956.97000000', '12.50847700', 1625533979999, '424805.88213857', 318, '4.84539900', '164547.82864212', '0'],
                    [1625533980000, '33956.97000000', '33956.98000000', '33911.63000000', '33922.97000000', '27.13624900', 1625534039999, '920787.38689960', 599, '9.45827800', '320932.75756577', '0'],
                    [1625534040000, '33921.44000000', '33939.99000000', '33873.33000000', '33880.55000000', '46.04541200', 1625534099999, '1560912.72489501', 1004, '12.50351300', '423761.88685854', '0']]
        return candles * 3

def test_moving_average_calculation():
    with patch.object(CalcMovingAverage, 'api_client', TestBinanceResponse()):
        sma = CalcMovingAverage('BTCUSDT').call()

        last_sma_value = sma['SMA'][29]
        avg = sum(sma['Close value'][-5:]) / 5

        assert avg == last_sma_value